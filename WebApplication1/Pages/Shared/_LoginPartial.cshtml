@using Microsoft.AspNetCore.Identity
@using Revia.Models
@using Microsoft.EntityFrameworkCore
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject ApplicationDbContext Context

<ul class="navbar-nav">
    @if (SignInManager.IsSignedIn(User))
    {
        var currentUserId = UserManager.GetUserId(User);
        ApplicationUser? currentUser = null;

        if (!string.IsNullOrEmpty(currentUserId))
        {
            // Reload user din DB cu AsNoTracking pentru date fresh
            currentUser = await Context.Users
            .AsNoTracking()
            .FirstOrDefaultAsync(u => u.Id == currentUserId);
        }

        @if (currentUser != null && !User.IsInRole(UserRoles.Admin))
        {
            int currentXP = currentUser.XP;
            int level = currentUser.Level;

            // Logica XP (Prag absolut: 500, 1000, 2000, ...)
            int xpNextTarget = 500 * (int)Math.Pow(2, level - 1);

            // Calculăm procentul
            double percentage = xpNextTarget > 0
            ? (double)currentXP / xpNextTarget * 100
            : 100;

            // Limităm vizual la 100%
            if (percentage > 100) percentage = 100;

            <li class="nav-item d-flex align-items-center me-3" style="min-width: 150px;">
                <div class="w-100">
                    @* TEXT ALB pentru XP și Nivel (Lizibil pe fundal negru) *@
                    <div class="d-flex justify-content-between text-white" style="font-size: 0.75rem;">
                        <span class="fw-bold">Lvl @level</span>
                        <span>@currentXP / @xpNextTarget XP</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar @(User.IsInRole("LocalGuide") ? "bg-success" : "bg-primary")"
                             role="progressbar"
                             style="width: @percentage%;">
                        </div>
                    </div>
                </div>
            </li>

            @if (User.IsInRole("LocalGuide"))
            {
                <li class="nav-item d-flex align-items-center me-2">
                    <span class="badge bg-success rounded-pill" title="Membru verificat">Local Guide 🌿</span>
                </li>
            }
        }

        <li class="nav-item">
            @* TEXT ALB pentru nume utilizator *@
            <a id="manage" class="nav-link text-white fw-bold" asp-area="Identity" asp-page="/Account/Manage/Index" title="Manage">
                <i class="fas fa-user-circle me-1"></i> @(currentUser?.FirstName ?? "Profil")
            </a>
        </li>
        <li class="nav-item">
            <form id="logoutForm" class="form-inline" asp-area="Identity" asp-page="/Account/Logout" asp-route-returnUrl="@Url.Page("/Index", new { area = "" })">
                @* TEXT ALB pentru butonul Logout *@
                <button id="logout" type="submit" class="nav-link btn btn-link text-white border-0">
                    <i class="fas fa-sign-out-alt me-1"></i> Logout
                </button>
            </form>
        </li>
    }
    else
    {
        <li class="nav-item">
            <a class="nav-link text-white-50" id="register" asp-area="Identity" asp-page="/Account/Register">Register</a>
        </li>
        <li class="nav-item">
            <a class="nav-link text-white-50" id="login" asp-area="Identity" asp-page="/Account/Login">Login</a>
        </li>
    }
</ul>